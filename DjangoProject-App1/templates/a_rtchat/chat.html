{% extends 'layouts/blank.html' %}

{% block content %}
<wrapper class="block max-w-[375px] mx-auto my-10 px-4">
    <!-- iPhone Dynamic Island -->
    <div class="relative bg-black h-14 rounded-t-3xl shadow-lg">
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-black w-16 h-3 rounded-xl mt-2"></div>
        <div class="flex justify-between items-center px-4 py-1 text-white">
            <div class="flex items-center space-x-2">
                <!-- Left side (battery, signal, etc.) -->
                <span class="text-sm">10:30</span>
                <div class="w-3 h-3 rounded-full bg-green-500"></div> <!-- Dummy Network icon -->
            </div>
            <div class="flex items-center">
                <!-- Right side (perhaps microphone, wifi, or icons) -->
                <span class="text-sm">Wi-Fi</span>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div id="chat_window" class="h-[85vh] flex flex-col bg-gray-800 rounded-3xl shadow-2xl relative">
        <!-- Chat Container -->
        <div id="chat_container" class="flex-1 overflow-y-auto bg-white rounded-t-3xl p-4" data-username="{{ user.username }}">
            <div id="chat_messages" class="flex flex-col space-y-4">
                {% for message in chat_messages reversed %}
                    {% include 'a_rtchat/message.html' with message=message user=user %}
                {% endfor %}
            </div>
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-gray-800 sticky bottom-0 z-10 rounded-b-3xl">
            <form id="chat_message_form" class="flex items-center w-full"
                  hx-ext="ws"
                  ws-connect="/ws/chatroom/public-chat"
                  ws-send
                  _="on htmx:wsAfterSend reset () me">
                {% csrf_token %}
                <div class="flex w-full items-center rounded-xl px-3 py-2 bg-white shadow-md">
                    <!-- Input Field -->
                    <input type="text" name="message" class="w-full p-2 rounded-l-xl text-gray-800 focus:outline-none" placeholder="Type a message..." />
                    <!-- Send Button -->
                    <button type="submit" class="ml-2 p-2 bg-blue-500 text-white rounded-r-xl hover:bg-blue-600 focus:outline-none">
                        Send
                    </button>
                </div>
            </form>
        </div>
    </div>
</wrapper>
{% endblock %}

{% block javascript %}
<script>
    // Function to scroll chat to the bottom
    function scrollToBottom() {
        const container = document.getElementById('chat_container');
        container.scrollTop = container.scrollHeight;
    }

    // Scroll to bottom on page load
    window.onload = scrollToBottom;

    // Handle WebSocket message received
    document.body.addEventListener('htmx:wsAfterMessage', function(event) {
        const data = JSON.parse(event.detail.message);
        const chatMessages = document.getElementById('chat_messages');
        
        // Create a temporary div to hold the message HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = data.html;
        
        // Add the message to the chat
        const messageDiv = tempDiv.firstElementChild;
        chatMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        scrollToBottom();
    });
</script>
{% endblock %}
